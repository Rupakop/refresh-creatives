<!doctype html>
<html>
<head>
  <title>Checkout — Refresh Elixir</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white">

<script>
/* CHANGE THIS IF YOU WANT LATER */
const UPI_ID = "nipurna05-3@oksbi";
const MERCHANT_NAME = "Refresh Elixir";

/* YOUR APPS SCRIPT URL */
const ORDER_API = "https://script.google.com/macros/s/AKfycbwrbeDZjspqEvLYnpkBucAfGNvHpTdqwVCTzNg23JPY4dMnPSBzQ2Swc31rD9fR8yD0/exec";

function buildUpiLink(amount) {
  const am = parseFloat(amount).toFixed(2);
  return `upi://pay?pa=${encodeURIComponent(UPI_ID)}&pn=${encodeURIComponent(MERCHANT_NAME)}&am=${encodeURIComponent(am)}&cu=INR`;
}
</script>

<section class="max-w-xl mx-auto px-6 py-16">
  <h1 class="text-3xl font-bold mb-6 text-center">Checkout</h1>

  <div id="cartBox"></div>

  <p class="mt-4 text-lg">
    Total: ₹<span id="totalAmount">0</span>
  </p>

  <input id="custName"
         placeholder="Full Name"
         class="w-full p-2 mt-4 bg-neutral-800 rounded">

  <input id="custPhone"
         placeholder="Phone Number"
         class="w-full p-2 mt-3 bg-neutral-800 rounded">

  <input id="custAddress"
         placeholder="Delivery Address"
         class="w-full p-2 mt-3 bg-neutral-800 rounded">

  <button onclick="placeOrder()"
          class="w-full mt-6 bg-green-600 py-3 rounded hover:bg-green-700">
    Place Order
  </button>
</section>

<script>
const cart = JSON.parse(localStorage.getItem("cart") || "[]");
const cartBox = document.getElementById("cartBox");
const totalAmountEl = document.getElementById("totalAmount");

let total = 0;

/* RENDER CART */
function renderCart() {
  cartBox.innerHTML = "";
  total = 0;

  if (!cart.length) {
    cartBox.innerHTML = `
      <p class="text-white/60 text-center">Your cart is empty.</p>
    `;
    totalAmountEl.textContent = "0";
    return;
  }

  cart.forEach((item, index) => {
    total += item.price * item.qty;

    const div = document.createElement("div");
    div.className = "border border-white/10 p-3 mb-3 rounded";

    div.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <div class="font-semibold">${item.name} (${item.ml}ml)</div>
          <div class="text-sm text-white/60">
            ₹${item.price} × ${item.qty} = ₹${item.price * item.qty}
          </div>
        </div>
        <button onclick="removeItem(${index})"
                class="text-red-500 text-sm">
          Remove
        </button>
      </div>
      <div class="mt-2 flex gap-2">
        <button onclick="changeQty(${index}, 1)"
          class="px-3 bg-neutral-700 rounded">+</button>
        <button onclick="changeQty(${index}, -1)"
          class="px-3 bg-neutral-700 rounded">−</button>
      </div>
    `;
    cartBox.appendChild(div);
  });

  totalAmountEl.textContent = total;
}

/* QUANTITY CHANGE */
function changeQty(i, diff) {
  cart[i].qty += diff;
  if (cart[i].qty <= 0) {
    cart.splice(i, 1);
  }
  localStorage.setItem("cart", JSON.stringify(cart));
  renderCart();
}

/* REMOVE ITEM */
function removeItem(i) {
  cart.splice(i, 1);
  localStorage.setItem("cart", JSON.stringify(cart));
  renderCart();
}

/* PLACE ORDER */
async function placeOrder() {
  if (!cart.length) {
    alert("Cart is empty");
    return;
  }
  if (!custName.value || !custPhone.value || !custAddress.value) {
    alert("Please fill all fields");
    return;
  }

  const payload = {
    name: custName.value.trim(),
    phone: custPhone.value.trim(),
    address: custAddress.value.trim(),
    items: cart,
    total: total,
    status: "PENDING"
  };

  try {
    await fetch(ORDER_API, {
      method: "POST",
      body: JSON.stringify(payload)
    });

    localStorage.removeItem("cart");

    /* REDIRECT TO GOOGLE PAY / UPI */
    location.href = buildUpiLink(total);

  } catch (err) {
    console.error(err);
    alert("Network error — try again.");
  }
}

renderCart();
</script>

</body>
</html>
